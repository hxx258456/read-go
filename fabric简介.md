## 核心特性

目前，为了实现安全、可扩展、易管理的企业级分布式账本，Fabric在架构设计上主要包括了如下特性：

●采用“背书（Endorse）->排序（Order）->提交（Commit）”模型，解耦排序处理与其他逻辑，消除网络整体瓶颈。

●交易节点逻辑上分为背书节点（Endorser）、记账节点（Committer）等角色，允许根据负载情况调整部署。

●支持多通道特性，不同通道之间的账本数据彼此完全隔离。配合私密数据库和权限管理，实现细粒度的隐私保护。

●支持可拔插的架构，包括共识、权限管理、加解密、账本机制、链码执行等模块，支持多种实现和多种合约语言。

●支持运行时的管理接口，可以在线查询健康状态和系统的各项运行指标，实时变更日志级别等，方便运维管理。

●集成了身份证书管理服务，通过Fabric CA项目提供完整的证书签发和撤销等管理功能。

## 基本概念

**联盟（consortium）**表示若干个组织通过现实手段达成一定的协议，彼此作为“命运共同体”成员。在Fabric区块链网络中，联盟成员认可彼此的身份、权限配置、责任划分，成员依据相同的交易逻辑产生数据、依据相同的策略认可交易。

**通道（channel）**是Fabric区块链网络中隔离账本交易数据的逻辑主体。一个通道对应着一个联盟，一个通道也对应着一个账本。通道中的账本数据在联盟成员之间共享，但完全与另一个通道的数据隔离。这就让通道与通道之间具有私有数据集合的功能，但通道在Fabric区块链网络中是“较重”的资源，每个通道均需完整地运行一套交易服务、账本服务、共识服务等，因此在设计通道时需慎重对待。更多的情况下，如果是为了隔离业务数据，应使用私有数据集合功能。

**组织（organization）**是参与Fabric区块链网络、组成一个联盟的基本单位，也是一个逻辑主体。任何因一定的属性、目的而将多个单体编制成集合的主体，都可以是组织，如现实中的公司、行业协会、多个工厂同类产品的生产线等。

**节点（peer）**是组成组织的个体在Fabric区块链网络中运行的基础设施实体。在Fabric区块链网络中，节点在广义概念上的专用名词为Peer。具体地，由于职责和功能的迥异，Fabric区块链网络将主要的参与节点分为orderer和peer，orderer节点主要负责运行系统通道、共识排序服务，peer节点负责背书、广播、散播等服务。但orderer节点和peer节点均可被视为区块链网络中广义概念上的节点，因而两者在配置上又存在很多类似的地方。

**智能合约（smart contract）**是使用编程语言实现的一种交易规则，以链码（chaincode）的形式部署在Fabric区块链网络中。智能合约属于通道，供联盟成员调用，产生交易数据。使用智能合约的目的是依托区块链网络赋予账本数据的可信性，在技术上完全地模拟实现商业交易规则，减少或消除人为干预合约履行的可能性。虽然智能合约支持Go、Java这样的高级语言，但在实际项目应用时，由于智能合约是依托区块链网络运行的，其在实用性、适用范围、效率、功能拓展等方面能力有限，因此Fabric官方也在积极探索拓展链码能力的途径。

**账本（ledger）**是Fabric区块链网络中数据存储的主体，用于以多种形式记录网络中所有发生的成功或失败的交易。具体地，账本使用blockfile存储区块，使用LevelDB或CouchDB存储来自区块的有效交易数据、区块索引、历史数据、私有交易数据。账本与通道是一对一的，账本与账本之间数据隔离，不产生任何关联。

**区块（block）**是区块链特性在数据存储方面的核心体现，也是Fabric区块链网络中账本数据存储的基本单位。区块的次序号由0开始，依次递增，前后块相互验证关联，形成一条不可篡改的链。一条链中区块的数量，也被称为高度（height）。一个通道的账本，可以视为一条区块链。

**交易（transaction）**是Fabric区块链网络的通道账本中组成区块的基本单位，主要描述了依据交易规则对应用通道中账本数据的读取、更改，以及对交易数据表示认可的背书主体。

**私有数据集合（private data collection）**是在Fabric区块链网络参与者之间隔离交易数据方面更细化的应用。通道与通道之间的交易数据是隔离的，但通道是“较重”的资源，而面对大量细化的交易数据隔离需求，通过通道实现数据隔离，显得过于“笨重”，因此设计了私有数据集合的概念。通道中，有不公开交易需求的若干参与者组成一个“小团体”，遵循一份私有数据集合定义，执行交易，产生的交易数据只在“小团体”范围内散播存储。

**共识机制（consensus mechanism）**保证了Fabric区块链网络的账本数据的可信、防篡改等特性。从技术上讲，Fabric区块链网络运行的最终目的是产生所有参与者均认可的账本数据，即在交易数据方面达成共识。Fabric区块链网络中的共识机制不单指某一共识算法（如PoW、PoS、Raft、PBFT等），而是基于交易处理流程的分阶段共识，并在分阶段共识的基础上，达成整个网络交易处理的共识。背书阶段，与交易相关的参与者已就链码定义（包括背书策略等）达成了共识，因而均认可链码产生的交易数据。排序阶段，由Raft算法主导确定每个交易在块和账本中的位置，参与者对此也达成共识。散播阶段，由gossip算法按已排序好的位置，将包含交易的块散播、存储至所有参与者节点本地的账本副本中，参与者对此也达成共识。在这些阶段共识的基础上，参与者对整个交易流程、结果可以达成共识。

## 整体架构

超级账本Fabric的整体架构,包括应用、账本、链码、区块链结构、数据库、共识、权限管理、数字证书、网络层等多个组件。

![](https://oscimg.oschina.net/oscnet/up-f1434e1dc9002fa1e998b496ee196deadb0.png)

其中，账本是最核心的资源，记录合约和交易数据，应用通过发起交易调用合约来向账本中记录数据。合约执行的逻辑通过链码来实现。多个节点共同组成网络，网络运行中发生的事件可以通过事件机制通知给应用甚至其他系统。权限管理则负责在整个过程中进行合适的访问控制。

账本实现依赖于核心的区块链结构、数据库存储、共识机制等技术；链码实现则依赖容器、状态机等技术；权限管理利用了已有的PKI体系、数字身份证书、加解密算法等诸多安全技术。

最底层由多个节点组成P2P网络，彼此通过gRPC通道进行交互，利用Gossip协议进行数据同步。层次化结构提高了架构的可扩展和可插拔性，底层开发者在二次开发时仅需修改相关的模块单元。

## 经典网络结构

![](https://res.weread.qq.com/wrepub/epub_43663948_2)

## 典型工作流程

根据交易生命周期各个阶段工作负载侧重不同的特点，Fabric将网络内节点分为CA节点、Orderer（排序）节点和Peer节点三大类。Peer节点在逻辑上全部对应通道内的记账节点，部分Peer节点还可兼任背书节点（Endorser）角色。这种角色分工，可以让不同类型节点专注处理自己所擅长的业务。
![](https://oscimg.oschina.net/oscnet/up-dc096bea0c569bd33d6e14cb7729820f2d1.png)

●客户端创建请求：客户端应用使用SDK与Fabric网络打交道。首先，客户端从CA获取合法的身份证书以便加入网络内的应用通道。发起正式交易前，需要先构造交易提案（Proposal）提交给Endorser进行背书。客户端收集到足够（背书策略决定）的背书支持后，可以利用背书构造一个合法的交易请求，发给Orderer进行排序处理。客户端还可以通过事件机制来监听网络中消息，获知交易是否被成功接收。

●Endorser节点进行背书：主要提供供客户端调用，完成对交易提案的背书（目前主要是签名）处理。收到来自客户端的交易提案后，首先进行合法性和ACL权限检查，检查通过则模拟运行交易，对交易导致的状态变化（以读写集形式记录，包括所读状态的键和版本，所写状态的键值）进行背书，并返回结果给客户端。

●Committer节点更新账本：负责维护区块链结构和数据库（包括状态数据库、历史数据库、索引数据库等）。该节点定期地从Orderer或领导节点获取排序后的批量交易区块结构，对这些交易进行落盘前的最终检查（包括交易消息结构、签名完整性、是否重复、读写集合版本是否匹配等）。检查通过后，将合法交易的执行结果写入账本，同时构造新的区块，更新区块中BlockMetadata[2]（TRANSACTIONS_FILTER）元数据，添加合法性标记。所有Peer都担任Committer角色。

●排序节点进行排序：Orderer为网络中所有合法交易进行全局排序，并将排序后的一批交易组合生成区块结构。Orderer不需要与交易内容打交道。

●CA管理身份证书：参照PKI架构，负责网络中所有证书的管理（签发的、撤销等）。实现位于单独的fabric-ca项目中。CA在签发证书后，自身并不参与网络中的交易过程。
	